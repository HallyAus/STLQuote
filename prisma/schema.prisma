generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Auth (NextAuth.js) ---

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// --- Core Models ---

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  passwordHash  String?
  role          String    @default("USER") // USER | ADMIN | SUPER_ADMIN
  disabled              Boolean   @default(false)
  mustChangePassword    Boolean   @default(false)
  marketingUnsubscribed Boolean   @default(false)
  lastLogin             DateTime?

  // Two-Factor Authentication (TOTP)
  totpSecret          String?
  totpEnabled         Boolean   @default(false)
  totpBackupCodes     String?   @db.Text  // JSON array of hashed backup codes
  pendingTotpSecret   String?   @db.Text  // Encrypted pending secret during 2FA setup
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Subscription
  subscriptionTier     String    @default("hobby") // hobby | starter | pro | scale
  subscriptionStatus   String    @default("trialing") // trialing | active | past_due | cancelled | inactive
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?   @unique
  trialEndsAt          DateTime?
  subscriptionEndsAt   DateTime?

  // Xero OAuth (per user)
  xeroTenantId       String?
  xeroAccessToken    String?
  xeroRefreshToken   String?
  xeroTokenExpiresAt DateTime?
  xeroConnectedAt    DateTime?

  // Asana OAuth (per user)
  asanaAccessToken     String?   @db.Text  // encrypted
  asanaRefreshToken    String?   @db.Text  // encrypted
  asanaTokenExpiresAt  DateTime?
  asanaConnectedAt     DateTime?
  asanaWorkspaceGid    String?
  asanaWorkspaceName   String?
  asanaProjectGid      String?
  asanaProjectName     String?
  asanaAutoCreateTasks Boolean   @default(false)

  // Shopify Custom App (per user)
  shopifyShopDomain      String?
  shopifyClientId        String?
  shopifyClientSecret    String?   @db.Text
  shopifyAccessToken     String?   @db.Text
  shopifyTokenExpiresAt  DateTime?
  shopifyConnectedAt     DateTime?
  shopifyLastSyncAt      DateTime?
  shopifyAutoCreateJobs  Boolean   @default(true)
  shopifyWebhookId       String?

  accounts           Account[]
  sessions           Session[]
  settings           Settings?
  printers           Printer[]
  materials          Material[]
  clients            Client[]
  quotes             Quote[]
  jobs               Job[]
  invoices           Invoice[]
  calculatorPresets  CalculatorPreset[]
  webhooks           Webhook[]
  suppliers          Supplier[]
  consumables        Consumable[]
  subscriptionEvents SubscriptionEvent[]
  quoteTemplates     QuoteTemplate[]
  stockTransactions  StockTransaction[]
  purchaseOrders     PurchaseOrder[]
  uploadLinks        UploadLink[]
  quoteRequests      QuoteRequest[]
  designs            Design[]
  modules            UserModule[]
  cloudConnections   CloudConnection[]
  dripEmails         DripEmailLog[]
  partDrawings       PartDrawing[]
}

model Settings {
  id                    String  @id @default(cuid())
  userId                String  @unique
  user                  User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  timezone              String  @default("Australia/Sydney")
  defaultCurrency       String  @default("AUD")
  defaultElectricityRate Float  @default(0.30) // $/kWh
  defaultMarkupPct      Float  @default(50.0)
  defaultLabourRate     Float  @default(35.0) // $/hr
  defaultOverheadMonthly Float @default(0.0)
  estimatedMonthlyJobs  Int    @default(20)
  minimumCharge         Float  @default(15.0)
  businessName          String?
  businessAddress       String?
  businessAbn           String?
  businessPhone         String?
  businessEmail         String?
  businessLogoUrl       String?
  quoteTermsText        String? @db.Text
  batchPricingTiers     String? @db.Text // JSON string of batch pricing tiers
  bankName              String?
  bankBsb               String?
  bankAccountNumber     String?
  bankAccountName       String?
  stripeConnectAccountId String?
  // Tax & Region
  taxRegion             String  @default("AU")       // AU | EU | UK | US | CA
  taxSubRegion          String?                      // state/province code
  defaultTaxPct         Float   @default(10)
  taxLabel              String  @default("GST")      // GST | VAT | Sales Tax | HST
  taxIdNumber           String?                      // ABN/VAT/EIN — label from region
  taxInclusive          Boolean @default(true)
  showTaxOnQuotes       Boolean @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model Printer {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name            String
  model           String?
  purchasePrice   Float    @default(0)
  lifetimeHours   Float    @default(5000)
  powerWatts      Float    @default(200)
  bedSizeX        Float?   // mm
  bedSizeY        Float?   // mm
  bedSizeZ        Float?   // mm
  currentHours    Float    @default(0)
  maintenanceCostPerHour Float @default(0.50)
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  quoteLineItems QuoteLineItem[]
  jobs           Job[]
  printerLoads   PrinterLoad[]
  consumables    Consumable[]

  @@index([userId])
}

model Material {
  id                 String   @id @default(cuid())
  userId             String
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type               String   @default("filament") // filament | resin
  materialType       String   // PLA, PETG, ABS, TPU, ASA, Nylon, etc.
  brand              String?
  colour             String?
  spoolWeightG       Float    @default(1000)
  price              Float    // price per spool/bottle
  density            Float?   // g/cm³
  stockQty           Int      @default(0)
  lowStockThreshold  Int      @default(2)
  barcode            String?  // manufacturer barcode (scanned from spool label)
  supplier           String?
  supplierId         String?
  supplierRef        Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  notes              String?  @db.Text
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  quoteLineItems     QuoteLineItem[]
  jobs               Job[]
  printerLoads       PrinterLoad[]
  supplierItems      SupplierItem[]
  stockTransactions  StockTransaction[]
  purchaseOrderItems PurchaseOrderItem[]

  @@index([userId])
  @@index([userId, stockQty])
}

model Client {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name                  String
  email                 String?
  phone                 String?
  company               String?
  billingAddress        String?  @db.Text
  shippingAddress       String?  @db.Text
  shippingSameAsBilling Boolean  @default(true)
  tags                  String[] @default([])
  notes                 String?  @db.Text
  paymentTermsDays      Int      @default(14)
  country               String?          // AU, US, UK, DE, FR, etc.
  stateProvince         String?          // CA, NSW, ON, QC, etc.
  taxExempt             Boolean  @default(false)
  taxIdNumber           String?          // Client's ABN/VAT/EIN
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  quotes       Quote[]
  invoices     Invoice[]
  jobs         Job[]
  interactions ClientInteraction[]
  designs      Design[]

  @@index([userId])
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
}

model Quote {
  id          String      @id @default(cuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  clientId    String?
  client      Client?     @relation(fields: [clientId], references: [id])
  quoteNumber String
  status      QuoteStatus @default(DRAFT)
  portalToken String?     @unique
  subtotal    Float       @default(0)
  markupPct   Float       @default(0)
  taxPct      Float       @default(0)
  taxLabel    String      @default("GST")
  tax         Float       @default(0)
  taxInclusive Boolean    @default(false)
  total       Float       @default(0)
  currency    String      @default("AUD")
  notes       String?     @db.Text
  terms       String?     @db.Text
  expiryDate  DateTime?
  sentAt      DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  lineItems    QuoteLineItem[]
  jobs         Job[]
  events       QuoteEvent[]
  invoices     Invoice[]
  designs      Design[]
  partDrawings PartDrawing[]

  @@unique([userId, quoteNumber])
  @@index([userId])
  @@index([userId, status])
  @@index([userId, createdAt])
}

model QuoteEvent {
  id        String   @id @default(cuid())
  quoteId   String
  quote     Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  action    String   // created | emailed | viewed | status_changed | accepted | rejected | line_item_added | line_item_updated | line_item_removed | duplicated | pdf_downloaded
  detail    String?  @db.Text
  actorId   String?  // userId who performed the action (null for portal/system actions)
  createdAt DateTime @default(now())

  @@index([quoteId])
}

model QuoteLineItem {
  id              String   @id @default(cuid())
  quoteId         String
  quote           Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  description     String
  printerId       String?
  printer         Printer? @relation(fields: [printerId], references: [id])
  materialId      String?
  material        Material? @relation(fields: [materialId], references: [id])
  printWeightG    Float    @default(0)
  printTimeMinutes Float   @default(0)
  materialCost    Float    @default(0)
  machineCost     Float    @default(0)
  labourCost      Float    @default(0)
  overheadCost    Float    @default(0)
  lineTotal       Float    @default(0)
  quantity        Int      @default(1)
  notes           String?  @db.Text

  @@index([quoteId])
}

enum JobStatus {
  QUEUED
  PRINTING
  POST_PROCESSING
  QUALITY_CHECK
  PACKING
  SHIPPED
  COMPLETE
}

model Job {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  quoteId           String?
  quote             Quote?    @relation(fields: [quoteId], references: [id])
  clientId          String?
  client            Client?   @relation(fields: [clientId], references: [id])
  printerId         String?
  printer           Printer?  @relation(fields: [printerId], references: [id])
  materialId        String?
  material          Material? @relation(fields: [materialId], references: [id])
  status            JobStatus @default(QUEUED)
  price             Float?
  actualTimeMinutes Float?
  actualWeightG     Float?
  notes             String?   @db.Text
  scheduledStart    DateTime?
  scheduledEnd      DateTime?
  startedAt         DateTime?
  completedAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  events   JobEvent[]
  photos   JobPhoto[]
  invoices Invoice[]
  designs  Design[]

  @@index([userId])
  @@index([userId, status])
  @@index([userId, createdAt])
}

model JobEvent {
  id         String   @id @default(cuid())
  jobId      String
  job        Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  fromStatus String?
  toStatus   String
  notes      String?  @db.Text
  createdAt  DateTime @default(now())

  @@index([jobId])
}

model CalculatorPreset {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name       String
  configJson String   @db.Text // JSON blob of calculator input values
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
}

// --- Auth Tokens ---

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@index([email])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@index([email])
}

// --- System Config (global key-value settings) ---

model SystemConfig {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

// --- Email Logs ---

model EmailLog {
  id        String   @id @default(cuid())
  to        String
  subject   String
  type      String   // quote | password_reset | verification | welcome | account_created | newsletter | test | other
  status    String   // sent | failed | skipped
  error     String?  @db.Text
  userId    String?  // admin/user who triggered the send (null for system emails)
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([type])
}

// --- Suppliers ---

model Supplier {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  email     String?
  phone     String?
  website   String?
  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items          SupplierItem[]
  materials      Material[]
  consumables    Consumable[]
  purchaseOrders PurchaseOrder[]

  @@index([userId])
}

model SupplierItem {
  id          String    @id @default(cuid())
  supplierId  String
  supplier    Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  materialId  String?
  material    Material? @relation(fields: [materialId], references: [id], onDelete: SetNull)
  partNumber  String?
  supplierSku String?
  unitCost    Float?
  url         String?
  notes       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([supplierId])
  @@index([materialId])
}

// --- Client Interactions ---

model ClientInteraction {
  id        String   @id @default(cuid())
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  userId    String
  type      String   // note | call | email | meeting
  content   String   @db.Text
  createdAt DateTime @default(now())

  @@index([clientId])
}

// --- Job Photos ---

model JobPhoto {
  id           String   @id @default(cuid())
  jobId        String
  job          Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  userId       String
  filename     String
  originalName String
  mimeType     String   @default("image/jpeg")
  sizeBytes    Int      @default(0)
  createdAt    DateTime @default(now())

  @@index([jobId])
}

// --- Consumables ---

model Consumable {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name              String
  category          String    @default("other") // nozzle | build_plate | belt | lubricant | other
  stockQty          Int       @default(0)
  lowStockThreshold Int       @default(1)
  unitCost          Float?
  supplierId        String?
  supplier          Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  printerId         String?
  printer           Printer?  @relation(fields: [printerId], references: [id], onDelete: SetNull)
  notes             String?   @db.Text
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  stockTransactions  StockTransaction[]
  purchaseOrderItems PurchaseOrderItem[]

  @@index([userId])
  @@index([userId, stockQty])
}

// --- Invoices ---

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  VOID
}

model Invoice {
  id            String        @id @default(cuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  quoteId       String?
  quote         Quote?        @relation(fields: [quoteId], references: [id])
  jobId         String?
  job           Job?          @relation(fields: [jobId], references: [id])
  clientId      String?
  client        Client?       @relation(fields: [clientId], references: [id])
  invoiceNumber String
  status        InvoiceStatus @default(DRAFT)
  portalToken   String?       @unique
  subtotal      Float         @default(0)
  taxPct        Float         @default(10) // GST
  taxLabel      String        @default("GST")
  tax           Float         @default(0)
  taxInclusive  Boolean       @default(false)
  total         Float         @default(0)
  currency      String        @default("AUD")
  dueDate       DateTime?
  paidAt        DateTime?
  notes         String?       @db.Text
  terms         String?       @db.Text
  sentAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  lineItems InvoiceLineItem[]

  @@unique([userId, invoiceNumber])
  @@index([userId])
  @@index([userId, status])
  @@index([userId, createdAt])
}

model InvoiceLineItem {
  id          String  @id @default(cuid())
  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  description String
  quantity    Int     @default(1)
  unitPrice   Float   @default(0)
  lineTotal   Float   @default(0)
  notes       String? @db.Text

  @@index([invoiceId])
}

// --- Subscription Events ---

model SubscriptionEvent {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action    String   // trial_started | upgraded | downgraded | cancelled | payment_failed | renewed | trial_expired
  detail    String?
  createdAt DateTime @default(now())

  @@index([userId])
}

// --- Waitlist ---

model Waitlist {
  id           String    @id @default(cuid())
  name         String
  email        String    @unique
  businessName String?
  status       String    @default("pending") // pending | approved | rejected
  createdAt    DateTime  @default(now())
  approvedAt   DateTime?
  approvedBy   String?
}

// --- System Logs ---

model SystemLog {
  id        String   @id @default(cuid())
  userId    String?
  type      String   // xero_sync, email, billing, auth, error
  level     String   @default("info") // info, warn, error
  message   String
  detail    String?  @db.Text
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

// --- Quote Templates ---

model QuoteTemplate {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  description String?  @db.Text
  lineItems   String?  @db.Text // JSON array of line item templates
  markupPct   Float    @default(0)
  taxPct      Float    @default(0)
  taxLabel    String   @default("GST")
  terms       String?  @db.Text
  notes       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

// --- Webhooks ---

model Webhook {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  url         String
  secret      String
  events      String[]  @default([])
  active      Boolean   @default(true)
  lastFiredAt DateTime?
  lastStatus  Int?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
}

// --- Stock Transactions ---

model StockTransaction {
  id           String      @id @default(cuid())
  userId       String
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  materialId   String?
  material     Material?   @relation(fields: [materialId], references: [id], onDelete: SetNull)
  consumableId String?
  consumable   Consumable? @relation(fields: [consumableId], references: [id], onDelete: SetNull)
  type         String      // received | used | adjusted | auto_deduct
  quantity     Int         // positive = in, negative = out
  balanceAfter Int         // stock after transaction
  notes        String?
  createdAt    DateTime    @default(now())

  @@index([userId])
  @@index([materialId])
  @@index([consumableId])
  @@index([createdAt])
}

// --- Purchase Orders ---

model PurchaseOrder {
  id               String    @id @default(cuid())
  userId           String
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  supplierId       String
  supplier         Supplier  @relation(fields: [supplierId], references: [id])
  poNumber         String    // PO-YYYY-NNN
  status           String    @default("DRAFT") // DRAFT | ORDERED | RECEIVED | CANCELLED
  expectedDelivery DateTime?
  totalCost        Float     @default(0)
  notes            String?   @db.Text
  invoiceUrl       String?   @db.Text  // base64 data URL for uploaded receipt
  invoiceFilename  String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  items PurchaseOrderItem[]

  @@unique([userId, poNumber])
  @@index([userId])
  @@index([supplierId])
}

model PurchaseOrderItem {
  id              String         @id @default(cuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder  @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  materialId      String?
  material        Material?      @relation(fields: [materialId], references: [id], onDelete: SetNull)
  consumableId    String?
  consumable      Consumable?    @relation(fields: [consumableId], references: [id], onDelete: SetNull)
  description     String
  quantity        Int
  unitCost        Float
  receivedQty     Int            @default(0)

  @@index([purchaseOrderId])
}

// --- Customer Upload Links ---

model UploadLink {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token       String    @unique
  label       String    @default("Default")
  active      Boolean   @default(true)
  expiresAt   DateTime?
  maxFileSize Int       @default(52428800) // 50MB in bytes
  allowedTypes String   @default("stl,3mf,step,obj,gcode,pdf") // comma-separated
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  quoteRequests QuoteRequest[]

  @@index([userId])
  @@index([token])
}

model QuoteRequest {
  id           String    @id @default(cuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  uploadLinkId String
  uploadLink   UploadLink @relation(fields: [uploadLinkId], references: [id], onDelete: Cascade)
  clientName   String
  clientEmail  String?
  description  String?   @db.Text
  status       String    @default("PENDING") // PENDING | REVIEWED | QUOTED | DISMISSED
  fileName     String
  originalName String
  filePath     String
  fileSizeBytes Int
  mimeType     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([userId])
  @@index([uploadLinkId])
  @@index([status])
}

// --- User Module Overrides ---

model UserModule {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  feature   String   // matches Feature type from tier.ts
  override  String   // "enabled" | "disabled"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, feature])
  @@index([userId])
}

// --- Design Studio ---

enum DesignStatus {
  IDEA
  RESEARCH
  DRAFTING
  PROTOTYPING
  PRODUCTION_READY
  ARCHIVED
}

model Design {
  id              String       @id @default(cuid())
  userId          String
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  designNumber    String
  name            String
  description     String?      @db.Text
  status          DesignStatus @default(IDEA)
  category        String?
  tags            String[]     @default([])

  // Target specs
  targetLengthMm  Float?
  targetWidthMm   Float?
  targetHeightMm  Float?
  targetWeightG   Float?

  // Print preferences
  suggestedMaterial String?
  suggestedColour   String?
  suggestedInfill   Float?
  printNotes        String?    @db.Text

  // Feasibility
  feasibilityScore  Int?       // 1-10
  feasibilityNotes  String?    @db.Text
  estimatedCost     Float?
  estimatedTimeMin  Float?

  // Links
  clientId        String?
  client          Client?      @relation(fields: [clientId], references: [id], onDelete: SetNull)
  quoteId         String?
  quote           Quote?       @relation(fields: [quoteId], references: [id], onDelete: SetNull)
  jobId           String?
  job             Job?         @relation(fields: [jobId], references: [id], onDelete: SetNull)

  thumbnailUrl    String?      @db.Text

  messages        DesignMessage[]
  files           DesignFile[]
  revisions       DesignRevision[]
  partDrawings    PartDrawing[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@unique([userId, designNumber])
  @@index([userId])
  @@index([status])
}

model DesignMessage {
  id        String   @id @default(cuid())
  designId  String
  design    Design   @relation(fields: [designId], references: [id], onDelete: Cascade)
  role      String   // "user" | "assistant"
  content   String   @db.Text
  imageData String?  @db.Text
  metadata  String?  @db.Text
  createdAt DateTime @default(now())

  @@index([designId])
}

model DesignFile {
  id           String          @id @default(cuid())
  designId     String
  design       Design          @relation(fields: [designId], references: [id], onDelete: Cascade)
  userId       String
  fileType     String          // reference_image | stl | 3mf | step | gcode | document | other
  filename     String
  originalName String
  mimeType     String
  sizeBytes    Int             @default(0)
  isPrimary    Boolean         @default(false)
  notes        String?         @db.Text
  revisionId   String?
  revision     DesignRevision? @relation(fields: [revisionId], references: [id], onDelete: SetNull)
  cloudFileId    String?       // ID of file in cloud storage
  cloudProvider  String?       // "google_drive" | "onedrive"
  createdAt    DateTime        @default(now())

  @@index([designId])
}

model DesignRevision {
  id          String       @id @default(cuid())
  designId    String
  design      Design       @relation(fields: [designId], references: [id], onDelete: Cascade)
  version     Int
  title       String
  description String?      @db.Text
  changes     String?      @db.Text
  files       DesignFile[]
  createdAt   DateTime     @default(now())

  @@index([designId])
}

// --- Part Drawings ---

model PartDrawing {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  drawingNumber  String               // PD-YYYY-NNN (auto-generated)
  title          String
  notes          String?  @db.Text

  // Source STL info
  sourceFilename String               // original STL filename
  sourceFileId   String?              // optional link to DesignFile

  // Parsed dimensions (mm)
  dimensionX     Float
  dimensionY     Float
  dimensionZ     Float
  volumeCm3      Float
  triangleCount  Int

  // Generated view images (base64 PNG data URIs)
  viewFront      String   @db.Text
  viewSide       String   @db.Text
  viewTop        String   @db.Text
  viewIso        String   @db.Text

  // Optional links
  quoteId        String?
  quote          Quote?   @relation(fields: [quoteId], references: [id], onDelete: SetNull)
  designId       String?
  design         Design?  @relation(fields: [designId], references: [id], onDelete: SetNull)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([userId, drawingNumber])
  @@index([userId])
}

// --- Printer Load (material ↔ printer assignment) ---

model PrinterLoad {
  id          String    @id @default(cuid())
  userId      String
  printerId   String
  printer     Printer   @relation(fields: [printerId], references: [id], onDelete: Cascade)
  materialId  String
  material    Material  @relation(fields: [materialId], references: [id], onDelete: Cascade)
  loadedAt    DateTime  @default(now())
  unloadedAt  DateTime?
  weightLoadedG  Float?   // weight on spool when loaded (optional, from scale)
  weightUsedG    Float?   // grams consumed while loaded (updated on unload/job complete)
  notes       String?

  @@index([userId])
  @@index([printerId])
  @@index([materialId])
  @@index([userId, unloadedAt]) // null = currently loaded
}

// --- Cloud Storage ---

model CloudConnection {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider        String    // "google_drive" | "onedrive"
  accessToken     String    @db.Text  // AES-256-GCM encrypted
  refreshToken    String    @db.Text  // AES-256-GCM encrypted
  tokenExpiresAt  DateTime?
  providerEmail   String?
  rootFolderId    String?   // ID of the Printforge root folder in cloud
  connectedAt     DateTime  @default(now())
  lastSyncAt      DateTime?
  syncEnabled     Boolean   @default(true)

  syncRecords     CloudSyncRecord[]

  @@unique([userId, provider])
  @@index([userId])
}

model CloudSyncRecord {
  id              String          @id @default(cuid())
  connectionId    String
  connection      CloudConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  localFileType   String          // "design_file" | "quote_pdf" | "invoice_pdf"
  localFileId     String
  cloudFileId     String
  cloudFileName   String
  cloudFolderPath String?
  direction       String          // "upload" | "download" | "bidirectional"
  localModifiedAt DateTime?
  cloudModifiedAt DateTime?
  syncStatus      String          @default("synced") // "synced" | "pending" | "conflict" | "error"
  errorMessage    String?         @db.Text
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([connectionId, localFileType, localFileId])
  @@index([connectionId])
}

// --- Drip Emails ---

model DripEmailLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  emailKey  String   // "day_0", "day_1", ... "day_7"
  sentAt    DateTime @default(now())

  @@unique([userId, emailKey])
  @@index([userId])
}
