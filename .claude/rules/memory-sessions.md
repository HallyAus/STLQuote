# Memory: Sessions

> Rolling summary of recent work. Claude adds entries after substantive work.
> Auto-loaded every session via `.claude/rules/`.
> Keep this to ~20 most recent entries. Archive older ones to `memory/sessions/`.

## Recent Sessions

<!-- Claude: add new entries at the top. Remove oldest when >20 entries. -->

- [2026-02-28] v5.0.0 — Design Studio + Module System: (1) UserModule model for per-user feature overrides (admin force-enable/disable any Pro feature); (2) Design Studio — 4 new Prisma models (Design/DesignMessage/DesignFile/DesignRevision), 10 API routes (CRUD, files, revisions, AI chat/brief/analyze-reference, create-quote), 10 UI components (list/detail with 6 tabs, AI chat with vision, files with drag-drop/lightbox, brief/feasibility cards, revision timeline, new-design form); (3) Updated tier.ts, auth-helpers, sidebar, global search, dashboard layout. Migration 0026.

- [2026-02-27] v4.15.3 — Security hardening for public release: HSTS, rate limits on 13 endpoints, SSRF prevention (new url-safety.ts), CSRF Origin validation in middleware, path traversal fixes, upload MIME magic bytes validation (STL/3MF/STEP/OBJ/G-code), email enumeration fix, Xero token removal, Content-Disposition sanitisation, job photo extension whitelist, portal token expiry, admin pagination, Stripe error leakage fix, 2FA audit logging, cookie expiry 30d→7d. Found/fixed bugs in MIME validation (gcode regex too permissive, STL check too loose). 29 files changed, 1 new file.

- [2026-02-26] v4.1.0 — 5 features + fixes: (1) Print farm calendar — weekly Gantt grid on Jobs page with printer rows, hour columns, native HTML5 drag-to-reschedule, unscheduled sidebar; (2) Bulk actions — checkbox selection + floating action bar on quotes/invoices pages, bulk API endpoints for status change/delete/mark paid; (3) Quote templates — full CRUD, save-as-template from quote detail, template dropdown on new quote, Templates page + sidebar nav; (4) Global search extended with invoices; (5) Material auto-deduct confirmed already complete. Fixes: logger import, actions card position on quote/invoice detail, dark mode chart visibility (Tailwind v4 oklch CSS vars). Migration 0017: Job scheduling fields + QuoteTemplate model.

- [2026-02-26] v3.0.0 — 9 features in 3 batches: (1) Supplier CRUD with supplied items (part numbers, SKUs, costs); (2) Invoice system (INV-YYYY-NNN, DRAFT→SENT→PAID/OVERDUE/VOID, PDF with TAX INVOICE/GST/ABN/PAID watermark, email with PDF attachment, create from quote or job); (3) Multi-currency display (AUD/USD/EUR/GBP symbols); (4) Business logo upload (base64, canvas 200x200, rendered in quote/invoice PDFs); (5) TagInput component with colour-coded chips, autocomplete, keyboard nav — replaced comma-separated tags on clients; (6) Client interaction timeline (note/call/email/meeting types); (7) Dashboard analytics cards (printer utilisation bars, top 5 materials, avg markup); (8) Job photo upload/gallery with lightbox, disk storage, auth-checked serving; (9) Consumables CRUD with stock alerts + reorder mailto on dashboard. Also: quote activity timeline (QuoteEvent audit trail), Docker OOM fixes, pnpm Dockerfile compatibility. Migration 0010_quote_events + 0011_suppliers_invoices_interactions_photos_consumables.
- [2026-02-25] v1.0.0 feature-complete batch: (1) Split auth.config.ts from auth.ts to fix bcryptjs Edge Runtime warnings in middleware; (2) Admin create users — POST /api/admin/users endpoint + modal on admin page; (3) G-code parser (gcode-parser.ts) supporting Bambu/OrcaSlicer/PrusaSlicer/Cura metadata extraction, upload panel accepts .gcode files with auto-fill to calculator; (4) Public landing/marketing page at / with hero, features, how-it-works, self-hosted pitch; (5) Database migrations — initial migration SQL, Dockerfile switched from db:push to migrate deploy; (6) Version bump to 1.0.0.
- [2026-02-25] Redesigned calculator page (hero page): integrated STL upload panel at top (full-width), compact preset bar below it, redesigned collapsible sections with colour-coded left-border accents and descriptions, replaced raw select elements with shared Select component, enhanced cost breakdown panel with STL filename badge, stronger total styling (bg-primary/15, 3xl font), larger Create Quote button with subtitle text. Updated handleCreateQuote to include STL dimensions in quote description. All existing functionality preserved (presets, printer/material select, create quote sessionStorage flow).
- [2026-02-25] Redesigned sidebar and header components: sidebar now has grouped navigation (Main, Business, Equipment) with labelled sections, left-border accent active states, separated Settings at bottom with subtle border, polished logo area (h-16, two-line branding), and clean footer with Printforge name + version. Header gains "New Quote" quick action button (desktop-only), breadcrumb-style subtitle for sub-routes (e.g. "Quotes" link above title on /quotes/new), and shadow-sm for better visual separation. Updated dashboard layout to compute and pass breadcrumb data.
- [2026-02-25] Implemented authentication + admin portal: NextAuth.js v5 with email/password credentials, bcrypt password hashing, JWT session strategy, Prisma adapter. Login/register pages with (auth) route group. Middleware protects all routes, redirects unauthenticated users to /login. Replaced hardcoded TEMP_USER_ID in all 19 API routes with getSessionUser() auth helper (supports impersonation). Admin portal at /admin with user stats, user table (name/email/role/status/activity), promote/demote, disable/enable, and impersonation via cookie. ADMIN_EMAIL env var auto-assigns admin role on registration. Header updated with user dropdown menu + impersonation banner. Sidebar updated with conditional Admin nav item + sign out button.
- [2026-02-25] Built calculator presets API routes: GET/POST at /api/calculator-presets (list all for temp-user ordered by updatedAt desc, create with name + configJson), PUT/DELETE at /api/calculator-presets/[id] (update name/configJson, delete with ownership check). Full Zod validation matching CalculatorInput shape. configJson stored as JSON string in Text column, parsed on read.
- [2026-02-25] Built PDF quote export: print-friendly HTML page at /quotes/[id]/pdf with browser print/save-as-PDF. Fetches quote + settings data, renders professional A4 layout (business header, client details, line items table, totals with markup, notes, T&Cs, footer). CSS @media print hides dashboard chrome, forces white background, avoids page breaks in table. Updated Export PDF button in quote-detail.tsx to navigate to PDF page.
- [2026-02-25] Built Jobs tracking page: API routes (GET/POST at /api/jobs, GET/PUT/DELETE at /api/jobs/[id]) with Zod validation, auto-set startedAt on PRINTING status, auto-set completedAt on COMPLETE status, ownership verification. Kanban board UI with 7 status columns (Queued/Printing/Post-Processing/Quality Check/Packing/Shipped/Complete), horizontal scroll, job cards with quote/printer info, move-to-next-status buttons, filter (All/Active/Complete), view toggle (Board/List), new job modal (accepted quotes + printers dropdowns), job detail modal with editable fields. Dark mode compatible.
- [2026-02-25] Built Dashboard home page: API route (/api/dashboard) aggregating stats (quote counts by status, accepted revenue, printer/material counts, low stock count), recent quotes, low stock alerts. Dashboard client component with stat cards (responsive 2x2/4-across grid), recent quotes list with status badges, low stock alerts with threshold display, quick action buttons. Updated sidebar with Dashboard nav item (LayoutDashboard icon) as first item, fixed isActive logic for root path. Replaced calculator redirect with DashboardPage render.
- [2026-02-25] Built Quotes UI: quotes list page with responsive table/cards, status filter dropdown, status badges (Draft/Sent/Accepted/Rejected/Expired with colours), click-to-navigate rows. Quote detail page with status dropdown, line items CRUD (add/edit/delete modal), totals section with editable markup %, notes/terms editing, export PDF placeholder, delete quote. New quote form with expiry date (default 30 days), markup %, notes, terms. Updated dashboard layout to resolve titles for sub-routes.
- [2026-02-25] Built Settings page: API route (/api/settings) with GET (upsert to create defaults) and PUT (Zod-validated update), server page at /settings, client component with three card sections (Calculator Defaults, Business Details, Quote Defaults), success toast on save, loading spinner, error banner. Follows existing materials/printers patterns.
- [2026-02-25] Built Quotes API routes: CRUD for quotes (/api/quotes, /api/quotes/[id]) with auto-generated PF-YYYY-NNN quote numbers, Zod validation, Prisma transactions, client/lineItems includes. Line item management routes (/api/quotes/[id]/line-items, /api/quotes/[id]/line-items/[lineItemId]) with automatic subtotal/total recalculation on add/update/delete. Follows existing printers/materials API patterns.
- [2026-02-25] Built Materials library CRUD page: API routes (GET/POST at /api/materials, GET/PUT/DELETE at /api/materials/[id]) with Zod validation, dashboard page at /materials, client component with responsive table (desktop) and cards (mobile), add/edit modal, material type filter dropdown, stock status badges (in stock/low stock/out of stock), colour swatches for hex values, price-per-gram auto-calculation, dark mode support.
- [2026-02-25] Built Printers CRUD page: API routes (GET/POST at /api/printers, GET/PUT/DELETE at /api/printers/[id]) with Zod validation, dashboard page at /printers, client component with card grid, add/edit modal with live hourly rate preview, delete confirmation, responsive layout, dark mode support.
- [2026-02-25] Built Calculator MVP UI: created ui primitives (input, button, card), layout components (sidebar, header, dashboard layout), calculator form with all input sections (material, machine, labour, overhead, pricing), cost breakdown panel with bar chart visualisation. All client-side calculation, dark mode default, responsive two-column layout.
- [2026-02-25] Created GitHub Actions auto-deploy workflow (.github/workflows/deploy.yml) and deploy setup docs (deploy/README.md) — SSH-based deploy to self-hosted Docker VM on push to main
- [2026-02-25] Project kickoff: reviewed PRD for printforge-quote, confirmed stack (Next.js 15 + TypeScript + Prisma + PostgreSQL + pnpm, self-hosted Docker), scaffolded initial codebase, created architecture doc
