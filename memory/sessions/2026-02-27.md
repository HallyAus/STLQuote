# Session: 2026-02-27

## Focus
Security hardening for public release (v4.15.1 → v4.15.3)

## Commits
- `639c319` fix: security hardening — rate limits, SSRF, CSRF, path traversal, audit logging
- `3420476` fix: tighten upload MIME validation — STL requires endsolid, gcode requires commands
- `0f50f44` chore: bump version to 4.15.3

## Changes (29 files, 1 new)

### New File
- `src/lib/url-safety.ts` — SSRF prevention utility (private IP blocklist)

### Security Fixes
- **next.config.ts**: HSTS header
- **src/middleware.ts**: CSRF Origin validation for state-changing requests
- **src/app/api/upload/[token]/route.ts**: Magic bytes MIME validation (STL, 3MF, STEP, OBJ, G-code)
- **src/app/api/files/[...path]/route.ts**: Path traversal fix + Content-Disposition sanitisation
- **src/app/api/uploads/[...path]/route.ts**: Path traversal fix
- **src/app/api/auth/2fa/verify/route.ts**: Rate limit (IP + user), cookie 30d→7d, audit logging
- **src/app/api/auth/2fa/disable/route.ts**: Rate limit
- **src/app/api/auth/2fa/backup-codes/route.ts**: Rate limit
- **src/app/api/auth/reset-password/route.ts**: Rate limit
- **src/app/api/auth/verify-email/route.ts**: Rate limit
- **src/app/api/auth/register/route.ts**: Email enumeration fix
- **src/app/api/admin/impersonate/route.ts**: Rate limit + audit logging
- **src/app/api/admin/newsletter/route.ts**: Rate limit
- **src/app/api/admin/test-email/route.ts**: Rate limit
- **src/app/api/admin/users/route.ts**: Pagination limit (500)
- **src/app/api/billing/webhook/route.ts**: Generic error message
- **src/app/api/jobs/[id]/photos/route.ts**: Extension whitelist
- **src/app/api/invoices/[id]/pdf/route.ts**: Content-Disposition sanitisation
- **src/app/api/quotes/[id]/pdf/route.ts**: Content-Disposition sanitisation
- **src/app/api/portal/[token]/route.ts**: 30-day token expiry
- **src/app/api/portal/[token]/respond/route.ts**: Rate limit
- **src/app/api/shopify/sync/route.ts**: Rate limit
- **src/app/api/xero/sync/route.ts**: Rate limit
- **src/app/api/xero/status/route.ts**: Remove access token from select
- **src/app/api/webhooks/route.ts**: SSRF blocklist
- **src/app/api/webhooks/[id]/test/route.ts**: SSRF blocklist
- **src/lib/webhooks.ts**: SSRF blocklist
- **package.json**: Version 4.15.0 → 4.15.3

## Bugs Found & Fixed
- G-code MIME validation regex `/;/` matched any file with semicolon byte — tightened to require actual G/M commands
- ASCII STL check only required "solid" prefix — now requires both "solid" header AND "endsolid" footer
- Type error: `"security"` not a valid LogType — changed to `"system"` and `"auth"`

## Discoveries
- Logger types are: `"xero_sync" | "email" | "billing" | "auth" | "system"` — no "security" type
- Windows `pnpm build` fails at symlink creation ("Collecting build traces") with `output: "standalone"` — works in Docker
- Binary STL can have ≤2 bytes padding after expected size (slicer alignment)
